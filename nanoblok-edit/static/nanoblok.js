function hexiso(d,a){var c=Array();c[1]=a.half+d.x;c[2]=a.full+d.x;c[3]=a.full+d.x;c[4]=a.half+d.x;c[5]=d.x;c[6]=d.x;c[7]=a.half+d.x;var b=Array();b[1]=d.y;b[2]=a.quarter+d.y;b[3]=a.third+d.y;b[4]=a.full+d.y;b[5]=a.third+d.y;b[6]=a.quarter+d.y;b[7]=a.half+d.y;return{x:c,y:b}}function canvasDrawSet(j,f,e){var c=null;if(e.grid){c="grids"}else{if($C.swatchActive){c="colors"}else{if($C.selection.enabled){c="selection"}else{c="blocks"}}}var k=context(c);k.globalAlpha=1;var a=j.pop();var d=hexiso(f,$C.blockSize);var b=-35;k.beginPath();k.moveTo(d.x[a],d.y[a]+b);var g=0;while(g<j.length||g==7){a=j.pop();k.lineTo(d.x[a],d.y[a]+b);g=g++}if(e.closed){k.closePath()}if(e.stroke!==false){k.strokeStyle=e.stroke;k.stroke()}if(e.fill!==false){k.fillStyle=e.fill;k.fill()}}var cubeShift={a:-20,b:-10,c:0,d:-30};var blokShift={a:-40,b:-20,c:0,d:-60};function colorBlockNew(b){var c=new Object();var a;if($C.swatchActive){a=cubeShift}else{a=blokShift}c.left="rgb("+smartShift(b.r,a.a)+", "+smartShift(b.g,a.a)+", "+smartShift(b.b,a.a)+")";c.right="rgb("+smartShift(b.r,a.b)+", "+smartShift(b.g,a.b)+", "+smartShift(b.b,a.b)+")";c.top="rgb("+smartShift(b.r,a.c)+", "+smartShift(b.g,a.c)+", "+smartShift(b.b,a.c)+")";c.inset="rgb("+smartShift(b.r,a.d)+", "+smartShift(b.g,a.d)+", "+smartShift(b.b,a.d)+")";return c}function smartShift(b,a){if(b+a<0){var c=b-a}else{if(b+a>255){var c=Math.min(b+a,255)}else{var c=b+a}}return c}function canvasBlock(a,b,c){var d={x:a.x,y:a.y-$C.blockSize.half*(b.z+1)};if($C.swatchActive){Arr=SwatchGhost}else{Arr=Voxel}if(Arr[b.x][b.y][b.z+1]==-1){canvasDrawSet([1,6,7,2],d,{closed:true,fill:c.top,stroke:c.inset})}else{if(!$C.swatchActive){if(!FieldVisible[Voxel[b.x][b.y][b.z+1]]){canvasDrawSet([1,6,7,2],d,{closed:true,fill:c.top,stroke:c.inset})}}}if(Arr[b.x-1][b.y][b.z]==-1&&Arr[b.x-1][b.y+1][b.z]==-1){canvasDrawSet([6,7,4,5],d,{closed:true,fill:c.left,stroke:c.inset})}else{if(Arr[b.x-1][b.y+1][b.z]!=-1&&Arr[b.x-1][b.y][b.z]==-1){canvasDrawSet([6,7,5],d,{closed:true,fill:c.left,stroke:c.inset})}}if(Arr[b.x][b.y+1][b.z]==-1&&Arr[b.x-1][b.y+1][b.z]==-1){canvasDrawSet([2,7,4,3],d,{closed:true,fill:c.right,stroke:c.inset})}else{if(Arr[b.x-1][b.y+1][b.z]!=-1&&Arr[b.x][b.y+1][b.z]==-1){canvasDrawSet([2,7,3],d,{closed:true,fill:c.right,stroke:c.inset})}}}function placeBlock(b){var a={x:GridField[b.id].x,y:GridField[b.id].y,z:$C.layerOffset.z};if(Voxel[a.x][a.y][a.z]!=-1){if(Field[Voxel[a.x][a.y][a.z]][3]!=$C.selected.color){placeBlockDraw(b,a)}else{loggit("Same block already exists at location.")}}else{placeBlockDraw(b,a)}}function placeBlockDraw(b,a){canvasBlock(GridField[b.id].coors,a,colorBlockNew(SwatchField[$C.selected.color][3]));Field.push([a.x,a.y,a.z,$C.selected.color]);FieldVisible.push(true);Voxel[a.x][a.y][a.z]=Field.length-1;loggit("Block placed at "+a.x+", "+a.y+", "+a.z+".");$C.posInd.redraw()}function removeBlock(b){var d=new Date();var a={x:GridField[b.id].x,y:GridField[b.id].y,z:0+$C.layerOffset.z};if(Voxel[a.x][a.y][a.z]!=-1){Voxel[a.x][a.y][a.z]=-1;popField(a.x,a.y,a.z);$C.posInd.clearBlocks();drawAllBlocks();$C.posInd.redraw();var c=new Date();loggit("The block at "+a.x+", "+a.y+", "+a.z+" was removed in "+(c-d)+" ms.")}else{loggit("Nothing to remove.")}}function drawAllBlocks(){var a={x:0,y:0,z:0};var d=0;var c=new Object();for(var b=0;b<Field.length;b++){if(FieldVisible[b]){a={x:Field[b][0],y:Field[b][1],z:Field[b][2]};d=a.x*$C.gridDims.c+a.y;c=GridField["x-"+d].coors;color=colorBlockNew(SwatchField[Field[b][3]][3]);canvasBlock(c,a,color)}}}function popField(a,d,c){for(var b=0;b<Field.length;b++){if(Field[b][0]==a&&Field[b][1]==d&&Field[b][2]==c){Field.splice(b,1);FieldVisible.splice(b,1);break}}}function drawSingleBlock(a,b){var e=Field[i];var d=e[0]*$C.gridDims.c+e[1];var c=GridField["x-"+d].coors;canvasBlock(c,a,b)}var t=new Object();var time1=new Object();var time0=new Object();var Swatch=new Array();var SwatchGhost=new Array();var SwatchField=new Array();function swatchInit(){var b=0;if($C.swatchInit===false){loggit("Initializing Color Array");for(var c=-1;c<$C.gridDims.c+1;c++){Swatch[c]=new Array();for(var d=-1;d<$C.gridDims.r+1;d++){Swatch[c][d]=new Array();for(var a=$C.gridDims.r+1;a>=-1;a--){if(a>-1&&a<$C.gridDims.c&&d>-1&&d<$C.gridDims.c&&c>-1&&c<$C.gridDims.c){color={r:(c+1)*8,g:(d+1)*8,b:256-(a+1)*8};Swatch[c][d][a]=b;SwatchField.push([a,d,c,color,true]);b++}else{Swatch[c][d][a]=-1}}}}$C.swatchInit=true}}function fillColorSwatch(){loggit("Drawing Color Cube!");if($C.animating===false){$C.animating=true;$C.layerOffset.z=30;$C.tools.gridUp();drawAllSwatch()}else{loggit("Animation already being run!")}}var h=0;function drawAllSwatch(){$C.swatchActive=true;var b={x:0,y:0,z:0};time0=new Date();for(var a=-1;a<$C.gridDims.r+1;a++){SwatchGhost[a]=new Array();for(var j=-1;j<$C.gridDims.r+1;j++){SwatchGhost[a][j]=new Array();for(var g=-1;g<$C.gridDims.c+1;g++){SwatchGhost[a][j][g]=-1}}}var e=0;var d=new Object();var f=0;for(var c=SwatchField.length-1;c>=0;c--){if(SwatchField[c][4]){b={x:SwatchField[c][0],y:SwatchField[c][1],z:SwatchField[c][2]};e=b.x*$C.gridDims.c+b.y;d=GridField["x-"+e].coors;color=colorBlockNew(SwatchField[c][3]);SwatchGhost[b.x][b.y][b.z]=1;canvasBlock(d,b,color);f++}}$C.animating=false;$C.swatchComplete=true;time1=new Date();loggit("Color Cube drawn in "+(time1-time0)+" ms.");$C.posInd.redraw()}function closeColorSwatch(){$C.swatchActive=false;$C.animating=false;$C.layerOffset.z=1;$C.tools.gridDown();SwatchGhost=new Array()}var Palette=function(){this.svgGroup=document.getElementById("sideColorsRight");this.colors=[26624,32386,32673,7040,255,21530,32056,32701,2048];this.paletteIndex=0;this.add=function(a){this.colors.push(a);this.draw()};this.remove=function(b){if($C.selected.color==parseInt(b.getAttribute("colorID"))){$C.selected.color=-1}var a=parseInt(b.getAttribute("colorPos"));this.colors.splice(a,1);this.draw()};this.swatch=function(e,b){var c=document.createElementNS(svgNS,"rect");var a=Math.floor(this.paletteIndex/9);var d=this.paletteIndex%9;c.setAttributeNS(null,"colorID",e);c.setAttributeNS(null,"colorPos",this.paletteIndex);c.setAttributeNS(null,"fill",this.color(e));c.setAttributeNS(null,"name","color");c.setAttributeNS(null,"id","color"+e);c.setAttributeNS(null,"x",-35+35*a);c.setAttributeNS(null,"y",35*d);c.setAttributeNS(null,"height",30);c.setAttributeNS(null,"width",30);c.setAttributeNS(null,"rx",3);c.setAttributeNS(null,"transform","skewY(26.565)");this.svgGroup.appendChild(c);this.paletteIndex++};this.color=function(c){var a=SwatchField[c][3];var b="rgb("+a.r+", "+a.g+", "+a.b+")";return b};this.draw=function(){this.paletteIndex=0;var b=this.svgGroup.childNodes;for(var a=b.length-1;a>-1;a--){this.svgGroup.removeChild(b[a])}for(var a=0;a<this.colors.length;a++){this.swatch(this.colors[a],a)}};this.faded=false;this.fade=function(c){if(c){var d=document.getElementsByName("color");for(var a=0,b=d.length;a<b;a++){d[a].setAttributeNS(null,"fill-opacity",0.3)}this.faded=true}else{var d=document.getElementsByName("color");for(var a=0,b=d.length;a<b;a++){d[a].setAttributeNS(null,"fill-opacity",1)}this.faded=false}}};function pickColor(e){var c=new Object();c.x=parseInt(e.getAttributeNS(null,"c"));c.y=parseInt(e.getAttributeNS(null,"r"));c.z=$C.layerOffset.z;var d=Swatch[c.z][c.y][c.x];var a=SwatchField[d][3];for(var b=0;b<$C.palette.colors.length;b++){$C.palette.colors[b]}if($C.palette.colors[d]==undefined){$C.palette.add(d)}$C.selected.color=d}function makeXHR(c,b,f){var a=-1;var d=new XMLHttpRequest();if(!d){loggit("Unable to connect.")}d.onreadystatechange=function(){if(d.readyState==4){try{a=d.status}catch(j){}if(a==200){loggit(d.response.responseText);d.onreadystatechage=function(){}}}};d.open(c,"/"+b,true);if(c=="POST"){d.setRequestHeader("Content-type","application/json");d.setRequestHeader("Content-length",f.length);d.setRequestHeader("Connection","close")}try{d.send(f)}catch(g){changeStatus(g)}}function saveField(){var a=[document.getElementById("saveAuthor").value,document.getElementById("saveTitle").value,Field,0.01,"public",imageCanvas()];data=JSON.stringify(a);makeXHR("POST","save",data)}function loadField(){var a=makeXHR("POST","load",a);Field=JSON.parse(a)}function imageCanvas(){var a=document.getElementById("display").toDataURL();return a}var Field=[];var FieldVisible=[];var GridField={};var Voxel=[];var Common=function(){this.windowSize={x:window.innerWidth,y:window.innerHeight};this.blockDims=null;this.smallDisplay=false;this.isoAngle=26.565;if(this.windowSize.x<725||this.windowSize.y<760){this.blockDims=15;loggit("Small display detected, adjusting.");this.smallDisplay=true}else{this.blockDims=20}this.blockSize={full:this.blockDims,half:this.blockDims/2,third:this.blockDims/2+this.blockDims/4,quarter:this.blockDims/4};this.gridDims={c:32,r:32};this.gridSize={x:this.gridDims.c*this.blockSize.full,y:this.gridDims.r*this.blockSize.quarter,fullY:this.gridDims.r*this.blockSize.full};this.center={x:this.windowSize.x/2,y:this.windowSize.y/2};this.edges={left:this.center.x-this.gridSize.x/2,right:this.center.x+this.gridSize.x/2,top:this.windowSize.y-this.gridSize.y*2,fullTop:this.windowSize.y-this.gridSize.y*4};this.offset={x:1,y:this.gridSize.y*2+31};this.palette=[[164,0,0,"red",null],[211,127,4,"orange",null],[213,184,8,"yellow",null],[42,197,18,"green",null],[43,84,200,"blue",null],[147,29,199,"purple",null],[190,67,180,"pink",null],[201,202,188,"white",null],[55,48,51,"black",null],[255,255,255,"transparent",null]];this.selected={color:26624,lastColor:0,tool:"color26624"};this.layerOffset={x:0,y:0,z:0};this.markerPosition={x:31,y:0,z:0};this.posInd=new PositionIndicator();this.mouseMove=false;this.tools=new Tools();this.toolNames=["Load","Save","Fill","Select","Colors","Delete"];this.toolMethods=["load","save","fill","select","swatch","remove"];this.animating=false;this.swatchInit=false;this.swatchActive=false;this.swatchComplete=false;testCompat();this.selection=new Selection();this.palette=new Palette();this.renderer=new Renderer()};function initVoxels(d){for(var a=-1;a<$C.gridDims.r+1;a++){if(d[a]==undefined){d[a]=new Array()}for(var c=-1;c<$C.gridDims.r+1;c++){if(d[a][c]==undefined){d[a][c]=new Array()}for(var b=-1;b<$C.gridDims.c+1;b++){d[a][c][b]=-1}}}}function testCompat(){var b=1;var a=0;JSONtest=JSON.parse('{"works" : true}');if(JSONtest.works){a++}if(a==b){}}function fillSquare(){var f=new Date();var c={x:0,y:0,z:0};var b=0;var a=0;var e=0;var d;if($C.animating==false){f=new Date();$C.animating=true;d=setInterval((function(){if(e>=1023){clearInterval(d);time1=new Date();loggit("Square drawn in "+(time1-f)+" ms.");$C.animating=false}blockColor=colorBlock($C.selected.color);c={x:a,y:b,z:$C.layerOffset.z};var j=a*$C.gridDims.c+b;var g=GridField["x-"+j].coors;Voxel[c.x][c.y][c.z]=$C.selected.color;Field.push([c.x,c.y,c.z,$C.selected.color]);canvasBlock(g,c,blockColor);a++;if(a>=32){b++;a=0;$C.posInd.redraw()}e++}),1)}}var Dialog={dialogEl:{},showing:false,text:["Test object","Second test object","Third test object!","Fourth","Fifth"],data:[],init:function(){this.dialogEl=document.getElementById("dialog");this.verts(10,"dialogOuter");this.verts(20,"dialogInner");this.hide();this.print()},verts:function(b,a){var c=[{x:$C.gridSize.x/2,y:b},{x:$C.gridSize.x-b,y:$C.gridSize.fullY/4+b/2},{x:$C.gridSize.x-b,y:$C.gridSize.fullY/4+$C.gridSize.fullY/2-b/2},{x:$C.gridSize.x/2,y:$C.gridSize.fullY-b},{x:b,y:$C.gridSize.fullY/4+$C.gridSize.fullY/2-b/2},{x:b,y:$C.gridSize.fullY/4+b/2}];var d=document.getElementById(a);this.draw(c,d)},draw:function(a,c){var e=[];var f="";for(var b=0;b<6;b++){e[b]={x:a[b].x+$C.edges.left,y:a[b].y+$C.edges.fullTop-33}}for(var d=0;d<6;d++){if(d==0){f+="M "+e[d].x+" "+e[d].y}else{if(d==5){f+=" "+e[d].x+" "+e[d].y+" Z"}else{f+=" L "+e[d].x+" "+e[d].y}}}c.setAttributeNS(null,"d",f);c.setAttributeNS(null,"stroke","none")},show:function(){this.dialogEl.style.display="inline";this.showing=true},hide:function(){this.dialogEl.style.display="none";this.showing=false},print:function(){var e="Choose a model:";var a=document.getElementById("dialogLeft");maketext(a,e);for(var c=0,d=this.text.length;c<d;c++){var b=maketext(a,"- "+this.text[c]);b.setAttributeNS(null,"id","leftList")}},lastHighlight:false,highlight:function(a){if(this.lastHighlight){this.lastHighlight.setAttributeNS(null,"fill","#666")}a.setAttributeNS(null,"fill","orange");this.lastHighlight=a}};function context(c){var a=document.getElementById(c);if(a.getContext){var b=a.getContext("2d")}return b}var PositionIndicator=function(){this.ctx=context("overlays");this.grids=document.getElementById("grids");this.blocks=document.getElementById("blocks");this.display=document.getElementById("display");this.overlays=document.getElementById("overlays");this.colors=document.getElementById("colors");this.selection=document.getElementById("selection");this.displayCtx=context("display");this.redraw=function(){var g={x:0,y:$C.windowSize.y};this.ctx.clearRect(0,0,$C.windowSize.x,$C.windowSize.y);this.ctx.globalAlpha=0.6;var l=$C.blockSize.full;var k=$C.blockSize.half;var j=$C.blockSize.quarter;var d=-1;if($C.smallDisplay){d=0}var c=($C.gridSize.y-d)-($C.markerPosition.x*$C.blockSize.quarter)+($C.gridDims.c-$C.layerOffset.z-1)*$C.blockSize.half;var a=g.x+$C.markerPosition.x*$C.blockSize.half;this.ctx.fillStyle="#f00";this.ctx.beginPath();this.ctx.moveTo(a,0+c);this.ctx.lineTo(k+a,c-j);this.ctx.lineTo(k+a,j+c);this.ctx.lineTo(0+a,k+c);this.ctx.closePath();this.ctx.fill();var b=6;if($C.smallDisplay){b=4}c=(b)+($C.markerPosition.z*$C.blockSize.quarter)+($C.gridDims.c-$C.layerOffset.z-1)*$C.blockSize.half;a=g.x+$C.gridSize.x/2+($C.markerPosition.z*$C.blockSize.half);this.ctx.fillStyle="#00f";this.ctx.beginPath();this.ctx.moveTo(a,c-j);this.ctx.lineTo(k+a,c);this.ctx.lineTo(k+a,k+c);this.ctx.lineTo(0+a,j+c);this.ctx.closePath();this.ctx.fill();var e=-306;if($C.smallDisplay){e=-229}a=($C.markerPosition.x*$C.blockSize.half)+($C.markerPosition.z*$C.blockSize.half);c=-($C.layerOffset.z*$C.blockSize.half)+($C.markerPosition.z*$C.blockSize.quarter)+($C.gridSize.y-$C.markerPosition.x*$C.blockSize.quarter)-e;this.ctx.fillStyle="#0f0";this.ctx.beginPath();this.ctx.lineTo(a+k,c+k);this.ctx.lineTo(a+l,c+j+k);this.ctx.lineTo(a+k,c+l);this.ctx.lineTo(a,c+j+k);this.ctx.closePath();this.ctx.fill();this.ctx.beginPath();this.ctx.moveTo(a+k,c);this.ctx.lineTo(a+l,c+j);this.ctx.lineTo(a+l,c+j+k);this.ctx.lineTo(a+k,c+l);this.ctx.lineTo(a,c+j+k);this.ctx.lineTo(a,c+j);this.ctx.closePath();this.ctx.strokeStyle="#0f0";this.ctx.stroke();var f=35+$C.blockDims*$C.layerOffset.z*0.5+$C.edges.top;this.ctx.beginPath();this.ctx.moveTo($C.gridCorners[0].x-$C.edges.left,$C.gridCorners[0].y-f);this.ctx.lineTo($C.gridCorners[1].x-$C.edges.left,$C.gridCorners[1].y-f);this.ctx.lineTo($C.gridCorners[2].x-$C.edges.left,$C.gridCorners[2].y-f);this.ctx.lineTo($C.gridCorners[3].x-$C.edges.left,$C.gridCorners[3].y-f);this.ctx.closePath();this.ctx.globalAlpha=1;this.ctx.strokeStyle="#f90";this.ctx.stroke();this.drawAll()};this.drawAll=function(){this.displayCtx.clearRect(0,0,$C.gridSize.x,$C.gridSize.y*4);this.displayCtx.globalCompositeOperation="source-over";this.displayCtx.drawImage(this.grids,0,0);if($C.swatchActive){this.displayCtx.drawImage(this.colors,0,0)}else{this.displayCtx.drawImage(this.blocks,0,0);this.displayCtx.globalAlpha=0.5;this.displayCtx.drawImage(this.selection,0,0);this.displayCtx.globalAlpha=1}this.displayCtx.drawImage(this.overlays,0,0)};this.clearBlocks=function(){context("blocks").clearRect(0,0,$C.gridSize.x,$C.gridSize.y*4)};this.clearSwatch=function(){context("colors").clearRect(0,0,$C.gridSize.x,$C.gridSize.y*4)};this.clearSelection=function(){context("selection").clearRect(0,0,$C.gridSize.x,$C.gridSize.y*4)}};function gridCoors(e){var d=0;for(var b=0;b<$C.gridDims.c;b++){for(var f=0;f<$C.gridDims.r;f++){var a;var c=[1,2,7,6];a={x:(b*$C.blockSize.half)+(f*$C.blockSize.half)+$C.offset.x,y:((f*$C.blockSize.quarter)+($C.gridSize.y-b*$C.blockSize.quarter))+$C.offset.y};GridField["x-"+d]={x:b,y:f,z:-1,coors:a};var c=[1,7,5,6];a={x:(b*$C.blockSize.half)+$C.offset.x,y:((f*$C.blockSize.half)+(-$C.gridSize.y-b*$C.blockSize.quarter))+$C.offset.y};GridField["y-"+d]={x:b,y:f,z:-1,coors:a};var c=[6,7,4,5];a={x:(b*$C.blockSize.half)+$C.gridSize.x/2+$C.offset.x,y:((f*$C.blockSize.half)+(-$C.gridSize.y*2+b*$C.blockSize.quarter))+$C.offset.y};GridField["z-"+d]={x:b,y:f,z:-1,coors:a};d++}}}function gridScreen(){}function drawSet(e,d,a){pathElement=document.createElementNS(svgNS,"path");var c=e.pop();var f="";f+="M "+d.x[c]+" "+d.y[c];var b=0;while(b<e.length||b==7){c=e.pop();f+=" L "+d.x[c]+" "+d.y[c];b=b++}if(a){f+=" Z"}pathElement.setAttributeNS(null,"d",f);return pathElement}function drawGrid(g){var c=document.getElementById("gridContainer");var b=0;var m=[0,0,0,0];for(var k=0;k<$C.gridDims.c;k++){for(var j=0;j<$C.gridDims.r;j++){var d=GridField["x-"+b];var n=[1,2,7,6];var a={x:d.coors.x+($C.windowSize.x-$C.gridSize.x)/2,y:d.coors.y+$C.windowSize.y-$C.gridSize.y*2};var l=hexiso(a,$C.blockSize);if(k==31&&j==0){m[0]={x:l.x[1],y:l.y[1]}}else{if(k==0&&j==0){m[1]={x:l.x[6],y:l.y[6]}}else{if(k==0&&j==31){m[2]={x:l.x[7],y:l.y[7]}}else{if(k==31&&j==31){m[3]={x:l.x[2],y:l.y[2]}}}}}var f=drawSet(n,l,true);f.setAttributeNS(null,"c",k);f.setAttributeNS(null,"r",j);var e="x-"+b;f.setAttributeNS(null,"id",e);c.appendChild(f);b++}}$C.gridCorners=m}function canvasGrid(d,c){var b=0;for(var g=0;g<$C.gridDims.c;g++){for(var f=0;f<$C.gridDims.r;f++){if(d=="bottom"){var e=[1,2,7,6];var a=GridField["x-"+b].coors;if(c=="standard"){var k="#eee";var j="#aaa"}if(c=="number"){var k="rgb("+(255-b/4)+", "+0+", "+0+")";var j="black"}canvasDrawSet(e,a,{closed:true,fill:k,stroke:j,grid:true})}if(d=="left"){var e=[1,7,5,6];var a=GridField["y-"+b].coors;if(c=="standard"){var k="#ddd";var j="#aaa"}if(c=="number"){var k="rgb("+0+", "+(255-b/4)+", "+0+")";var j="black"}canvasDrawSet(e,a,{closed:true,fill:k,stroke:j,grid:true})}if(d=="right"){var e=[6,7,4,5];var a=GridField["z-"+b].coors;if(c=="standard"){var k="#ccc";var j="#aaa"}if(c=="number"){var k="rgb("+0+", "+0+", "+(255-b/4)+")";var j="black"}canvasDrawSet(e,a,{closed:true,fill:k,stroke:j,grid:true})}b++}}}function InitEvents(){window.addEventListener("mousedown",function(a){Click(a);mouseDown=true},false);window.addEventListener("mouseup",function(a){mouseDown=false},false);if(!$C.mouseMove){window.addEventListener("mouseover",function(a){Hover(a,"in")},false);window.addEventListener("mouseout",function(a){Hover(a,"out")},false)}if($C.mouseMove){window.addEventListener("mousemove",function(a){MousePos(a)},false)}window.addEventListener("keydown",function(a){Key(a)},false);window.addEventListener("keyup",function(a){Key(a)},false);window.onresize=function(){if(initialized){loggit("Resolution change detected, click refresh button.")}displayResized=true}}function Click(b){var e=b.target;var a=["gridUp","gridDown","rotLeft","rotRight"];for(var c=0,d=$C.toolNames.length;c<d;c++){if(e.id=="toolButton"+toolNames[c]||e.id=="toolText"+toolNames[c]){$C.tools[$C.toolMethods[c]]()}}for(var c=0,d=a.length;c<d;c++){if(e.id==a[c]+"Button"||e.id==a[c]+"Text"){$C.tools[a[c]]()}}if(e.id.substr(0,5)=="color"){if($C.palette.faded){$C.palette.remove(e)}else{$C.selected.lastColor=$C.selected.color;$C.selected.color=parseInt(e.getAttribute("colorID"));$C.tools.color()}}if($C.selected.tool=="toolButtonDelete"&&e.id.substr(0,2)=="x-"){removeBlock(e)}else{if($C.selected.tool=="toolButtonSelect"&&e.id.substr(0,2)=="x-"){$C.selection.select(e)}else{if($C.swatchActive&&e.id.substr(0,2)=="x-"){pickColor(e)}else{if(e.id.substr(0,2)=="x-"){placeBlock(e)}}}}}function Hover(a,b){var c=null;if($C.mouseMove){c=a}else{c=a.target}if((c.id.substr(0,2)=="x-")&&mouseDown&&b=="in"&&$C.selected.tool.substr(0,5)=="color"){placeBlock(c)}else{if((c.id.substr(0,2)=="x-")&&mouseDown&&b=="in"&&$C.selected.tool=="toolButtonDelete"){removeBlock(c)}}if(c.id.substr(0,2)=="x-"&&b=="in"){$C.markerPosition.x=c.getAttribute("c");$C.markerPosition.z=c.getAttribute("r");$C.posInd.redraw()}if(c.id=="leftList"){Dialog.highlight(c)}}function Key(a){ctrlPressed=a.ctrlKey;if(a.type=="keydown"){if(a.keyCode==68){$C.tools.remove()}if(a.keyCode==67){$C.tools.swatch()}if(a.keyCode==70){$C.tools.fill()}if(a.keyCode==83&&!ctrlPressed){$C.tools.select()}if(a.keyCode==38){$C.tools.gridUp()}if(a.keyCode==40){$C.tools.gridDown()}if(a.keyCode==37){$C.tools.rotLeft()}if(a.keyCode==39){$C.tools.rotRight()}if(a.keyCode==83&&ctrlPressed){$C.tools.save()}if(a.keyCode==76&&ctrlPressed){$C.tools.load()}if(a.keyCode==16){$C.palette.fade(true)}if(a.keyCode==69){$C.renderer.render()}}if(a.type=="keyup"){if(a.keyCode==16){$C.palette.fade(false)}}}var initialized=false;window.addEventListener("load",function(){Initialize()},false);var mouseDown=false;var displayResized=false;function Initialize(){loggit("Program loaded.");var b=new Date();window.$C=new Common();initVoxels(Voxel);swatchInit();Update("initialize",{gridMode:"standard"});var a=new Date();loggit("Program initialized in "+(a-b)+" ms.");initialized=true;InitEvents()}function Update(b,a){if(b=="resize"||b=="initialize"){gridCoors()}if(b=="resize"||b=="initialize"){drawUI();drawGrid("bottom")}if(b=="resize"||b=="canvas"||b=="initialize"){canvasGrid("bottom",a.gridMode);canvasGrid("left",a.gridMode);canvasGrid("right",a.gridMode);if(a.gridMode=="standard"){$C.tools.selectColor()}}Dialog.init();$C.posInd.redraw()}var Renderer=function(){this.canvas=document.getElementById("renderer");this.ctx=context("renderer");this.test=function(){var a=context("grids");a.fillStyle="orange";a.fillRect(0,0,3,3);var b=a.getImageData(0,0,3,3);console.log(b)};this.render=function(){this.clear();var c={r:255,g:255,b:255};var b=this.ctx.createImageData(this.canvas.width,this.canvas.height);var d=0;for(var f=0;f<64;f++){for(var a=0;a<64;a++){for(var e=0;e<32;e++){if(Voxel[Math.floor(a/2)][Math.floor(f/2)][e]!=-1){c=SwatchField[Field[Voxel[Math.floor(a/2)][Math.floor(f/2)][e]][3]][3]}}d=(a+f*64)*4;b.data[d+0]=c.r;b.data[d+1]=c.g;b.data[d+2]=c.b;b.data[d+3]=255;c={r:255,g:255,b:255}}}this.ctx.putImageData(b,0,0)};this.clear=function(){this.ctx.clearRect(0,0,64,64)}};var time0;var SelectionVox=new Array();var Selection=function(){this.enabled=false;this.start={x:0,y:0,z:0};this.end={x:0,y:0,z:0};this.begin=true;this.area={x:0,y:0,z:0};this.selectionField=new Array();this.select=function(a){time0=new Date();this.enabled=true;if(this.begin){this.start.x=parseInt(a.getAttributeNS(null,"c"));this.start.y=parseInt(a.getAttributeNS(null,"r"));this.start.z=$C.layerOffset.z;this.end.x=parseInt(a.getAttributeNS(null,"c"));this.end.y=parseInt(a.getAttributeNS(null,"r"));this.end.z=$C.layerOffset.z;this.begin=false}else{this.end.x=parseInt(a.getAttributeNS(null,"c"));this.end.y=parseInt(a.getAttributeNS(null,"r"));this.end.z=$C.layerOffset.z}this.draw()};this.deselect=function(){this.start={x:0,y:0,z:0};this.end={x:0,y:0,z:0};this.begin=true;$C.posInd.clearSelection();$C.posInd.redraw();this.enabled=false;console.log("selection off")};this.draw=function(){$C.posInd.clearSelection();for(var j=-1;j<$C.gridDims.r+1;j++){SelectionVox[j]=new Array();for(var f=-1;f<$C.gridDims.r+1;f++){SelectionVox[j][f]=new Array();for(var e=-1;e<$C.gridDims.c+1;e++){SelectionVox[j][f][e]=-1}}}var k={x:0,y:0,z:0};var b=0;var g=Math.abs(this.end.x-this.start.x);var d=Math.abs(this.end.y-this.start.y);var c=Math.abs(this.end.z-this.start.z);var a={};for(var j=0;j<g+1;j++){for(var f=0;f<d+1;f++){for(var e=0;e<c+1;e++){if(this.begin){k.x=this.start.x;k.y=this.start.y;k.z=this.start.z}else{a={x:j,y:f,z:e};k=this.normalize(this.start,this.end,a)}this.selectionField.push([k.x,k.y,k.z]);gridPosition=k.x*$C.gridDims.c+k.y;coors=GridField["x-"+gridPosition].coors;yellow="rgb(255, 255, 0)";color={left:yellow,right:yellow,top:yellow,inset:yellow};canvasBlock(coors,k,color);SelectionVox[j][f][e]=1;b++}}}$C.posInd.redraw();var l=new Date();console.log(g+", "+d+", run : "+b+" times.");loggit("Selected "+b+" blocks.");this.area={x:g,y:d,z:c}};this.fill=function(){var e=new Date();var d={};var b={};for(var f=0;f<this.area.z;f++){for(var g=-1;g<this.area.y;g++){for(var a=this.area.x+1;a>0;a--){d={x:a,y:g,z:f};b=this.normalize(this.start,this.end,d);Field.push([b.x,b.y,b.z,$C.selected.color]);console.log(b);Voxel[a][g][f]=Field.length-1}}}this.deselect();drawAllBlocks();$C.posInd.redraw();var c=new Date();console.log("Fill took: "+(c-e)+"ms.")};this.remove=function(){};this.normalize=function(d,b,c){var a={x:0,y:0,z:0};if(d.x>b.x){a.x=c.x+b.x}else{a.x=c.x+d.x}if(d.y>b.y){a.y=c.y+b.y}else{a.y=c.y+d.y}if(d.z>b.z){a.z=c.z+b.z}else{a.z=c.z+d.z}return a}};function fillSelection(){}function removeSelection(){}var svgNS="http://www.w3.org/2000/svg";var loggitLog=new Array();function loggit(e){var d=document.getElementById("debugText");var b=d.getElementsByTagName("tspan").length;var c=5;if(b>=c){d.removeChild(d.firstChild)}var a=maketext(d,e);loggitLog.push(e)}function maketext(b,c){var a=document.createElementNS(svgNS,"tspan");a.setAttributeNS(null,"x","7");a.setAttributeNS(null,"dy","15");a.textContent=c;b.appendChild(a);b.getElementsByTagName("tspan")[0].setAttributeNS(null,"dy",2);return a}var Tools=function(){this.activate=function(a){if($C.selected.tool=="toolButton"+a){this.selectColor()}else{document.getElementById($C.selected.tool).setAttributeNS(null,"stroke-opacity","0.0");$C.selected.tool="toolButton"+a;document.getElementById($C.selected.tool).setAttributeNS(null,"stroke-opacity","1.0");loggit($C.selected.tool.substr(10,100)+" tool activated.")}};this.selectColor=function(){if($C.selected.lastColor!=-1){document.getElementById($C.selected.tool).setAttributeNS(null,"stroke-opacity","0.0")}$C.selected.tool="color"+$C.selected.color;document.getElementById($C.selected.tool).setAttributeNS(null,"stroke-opacity","1.0")};this.save=function(){saveField();loggit("Blocks saved.")};this.load=function(){if(Dialog.showing){Dialog.hide()}else{Dialog.show()}};this.refresh=function(){Update("refresh",{gridMode:"standard"});loggit("Canvas refreshed.")};this.remove=function(){if($C.selection.enabled){$C.selection.remove()}else{this.activate("Delete")}};this.gridUp=function(){if($C.layerOffset.z<($C.gridDims.r-1)){$C.layerOffset.z++;$C.posInd.redraw();var b=-389;if($C.smallDisplay){b=-309}document.getElementById("gridContainer").setAttributeNS(null,"transform","translate(-1,"+(b-$C.layerOffset.z*$C.blockSize.half)+")");if($C.swatchActive){for(var d=0;d<1024;d++){SwatchField[d+(($C.layerOffset.z)*1024)][4]=true}$C.posInd.clearSwatch();drawAllSwatch()}else{for(var a=0,c=Field.length;a<c;a++){if(Field[a][2]==$C.layerOffset.z){FieldVisible[a]=true}}$C.posInd.clearBlocks();drawAllBlocks();$C.posInd.redraw()}loggit("Slice up to "+$C.layerOffset.z)}};this.gridDown=function(){if($C.layerOffset.z>0){$C.layerOffset.z--;$C.posInd.redraw();var b=-389;if($C.smallDisplay){b=-309}document.getElementById("gridContainer").setAttributeNS(null,"transform","translate(-1,"+(b-$C.layerOffset.z*$C.blockSize.half)+")");if($C.swatchActive){for(var d=0;d<1024;d++){SwatchField[d+(($C.layerOffset.z+1)*1024)][4]=false}$C.posInd.clearSwatch();drawAllSwatch()}else{for(var a=0,c=Field.length;a<c;a++){if(Field[a][2]>$C.layerOffset.z){FieldVisible[a]=false}}$C.posInd.clearBlocks();drawAllBlocks();$C.posInd.redraw()}loggit("Slice down to "+$C.layerOffset.z)}};this.color=function(){this.selectColor()};this.swatch=function(){if($C.swatchActive){this.activate("Colors");closeColorSwatch();loggit("Color Cube closed.")}else{this.activate("Colors");fillColorSwatch()}};this.rotLeft=function(){if(!$C.swatchActive){rotate(1)}};this.rotRight=function(){if(!$C.swatchActive){rotate(0)}};this.select=function(){this.activate("Select");if($C.selection.enabled){$C.selection.deselect()}else{}};this.fill=function(){if($C.selection.enabled){$C.selection.fill();loggit("Selection fill.")}else{this.activate("Fill")}}};var rotation=0;function rotate(k){var m=new Object();if($C.swatchActive){initVoxels(Swatch)}else{initVoxels(Voxel)}var l=0;var j=0;var g=0;var f=0;var d=0;if($C.swatchActive){Fld=SwatchField}else{Fld=Field}var c=(90*Math.PI)/180;if(!k){c=(-90*Math.PI)/180}for(var e=0,n=Fld.length;e<n;e++){f=Fld[e][0];d=Fld[e][1];g=Fld[e][2];f++;d++;l=Math.round(f*Math.cos(c)-d*Math.sin(c));j=Math.round(f*Math.sin(c)+d*Math.cos(c));if(l<0){l=($C.gridDims.c)+l}if(j<0){j=($C.gridDims.r)+j}if(k){j--}else{l--}var b=Fld[e][3];var a=false;if($C.swatchActive){a=Fld[e][4]}if($C.swatchActive){Fld[e]=[l,j,g,b,a]}else{Fld[e]=[l,j,g,b]}Voxel[l][j][g]=Fld[e][3]}if($C.swatchActive){SwatchField=Fld;$C.posInd.clearSwatch();drawAllSwatch()}else{Field=Fld;$C.posInd.clearBlocks();drawAllBlocks()}$C.posInd.redraw();if(k){if(rotation<3){rotation++}else{rotation=0}loggit("Rotated left to "+rotation*90+" degrees.")}else{if(rotation>0){rotation--}else{rotation=3}loggit("Rotated right to "+rotation*90+" degrees.")}}var canvases=["grids","blocks","overlays","display","debug","colors","selection"];var toolNames=["Load","Save","Fill","Select","Colors","Delete",];function moveElement(b,a){var c=document.getElementById(b);var d="";if(a.move){d+="translate("+a.move.x+","+a.move.y+")";if(a.skewX||a.skewY){d+=","}}if(a.skewY){d+="skewY("+a.skewY+")";if(a.skewX){d+=","}}if(a.skewX){d+="skewX("+a.skewX+")"}c.setAttributeNS(null,"transform",d);if(a.height){c.setAttributeNS(null,"height",a.height)}if(a.width){c.setAttributeNS(null,"width",a.width)}}function drawUI(){moveElement("logoText",{skewY:-$C.isoAngle});moveElement("grid",{height:$C.windowSize.y-5});for(var f=0,o=canvases.length;f<o;f++){var b=document.getElementById(canvases[f]);b.setAttributeNS(null,"height",$C.gridSize.fullY+2);b.setAttributeNS(null,"width",$C.gridSize.x);b.style.top=$C.edges.top-$C.gridSize.y*2-34+"px";b.style.left=$C.edges.left+"px"}var j=-389;if($C.smallDisplay){j=-309}moveElement("gridContainer",{move:{x:-1,y:j}});moveElement("statusContainer",{move:{x:$C.edges.left,y:($C.edges.top-$C.gridSize.y-145)}});moveElement("sideButtonsTop",{move:{x:$C.center.x+5,y:$C.edges.top-$C.gridSize.y*2-121}});moveElement("sideButtonsLeft",{move:{x:$C.edges.left-25,y:$C.edges.top-$C.gridSize.y-20}});moveElement("yAxis",{move:{x:$C.edges.left+$C.gridSize.x/4,y:$C.edges.top+$C.gridSize.y*1.5},skewY:26.565,skewX:-45});moveElement("xAxis",{move:{x:$C.edges.left+$C.gridSize.x/2+$C.gridSize.x/4-20,y:$C.edges.top+$C.gridSize.y*1.5+10},skewY:-26.565,skewX:45});moveElement("sideColorsRight",{move:{x:$C.edges.right+40,y:$C.edges.top-$C.gridSize.y-9}});$C.palette.draw();for(var f=0;f<6;f++){var m=0;var l=0;if(f%2){m=30*f-30}else{m=30*f}if(f%2){l=0}else{l=38}var n=document.createElementNS(svgNS,"rect");n.setAttributeNS(null,"id","toolButton"+$C.toolNames[f]);n.setAttributeNS(null,"x",m);n.setAttributeNS(null,"y",l);n.setAttributeNS(null,"height",30);n.setAttributeNS(null,"width",52);n.setAttributeNS(null,"rx",3);n.setAttributeNS(null,"transform","skewY(26.565)");var e=document.createElementNS(svgNS,"text");e.setAttributeNS(null,"id","toolText"+$C.toolNames[f]);e.setAttributeNS(null,"x",m+4);e.setAttributeNS(null,"y",l+24);e.setAttributeNS(null,"fill","white");e.setAttributeNS(null,"fill-opacity","1");e.setAttributeNS(null,"stroke","none");e.setAttributeNS(null,"transform","skewY(26.565)");e.textContent=toolNames[f];var k=document.getElementById("sideButtonsTop");k.appendChild(n);k.appendChild(e)}var d=96;if($C.smallDisplay){d=20}moveElement("renderDisplay",{move:{x:$C.edges.right-d,y:$C.edges.fullTop}});var a=document.getElementById("renderer");a.setAttributeNS(null,"height",64);a.setAttributeNS(null,"width",64);a.style.left=$C.edges.right-d+"px";a.style.top=$C.edges.fullTop+"px";if($C.smallDisplay){document.getElementById("debugBox").setAttributeNS(null,"width",234)}var c={x:$C.edges.left+$C.gridSize.x/2+15,y:$C.edges.fullTop-125};var g=document.getElementById("dialogSave");g.style.posLeft=c.x+75;g.style.posTop=c.y;moveElement("saveBG",{move:{x:c.x,y:c.y},skewX:-116.565});moveElement("dialogLeft",{move:{x:$C.edges.left+30,y:$C.edges.fullTop+$C.gridSize.y/2+70},skewY:-26.565,height:$C.gridSize.y*2-40,width:$C.gridSize.x/2-30})};